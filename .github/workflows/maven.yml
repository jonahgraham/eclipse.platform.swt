# This workflow will build a Java project with Maven, and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://help.github.com/actions/language-and-framework-guides/building-and-testing-java-with-maven

name: SWT Matrix Build
concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
    types: [opened, reopened, synchronize, labeled]

jobs:
  event_file:
    name: "Event File"
    runs-on: ubuntu-latest
    steps:
    - name: Upload
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: Event File
        path: ${{ github.event_path }}
  changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      win32:  ${{ steps.filter.outputs.win32 }}
      gtk:    ${{ steps.filter.outputs.gtk }}
      cocoa:  ${{ steps.filter.outputs.cocoa }}
      md:     ${{ steps.filter.outputs.md }}
      other:  ${{ steps.filter.outputs.other }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            win32:
              - '**/win32/**'
            gtk:
              - '**/gtk/**'
            cocoa:
              - '**/cocoa/**'
            md:
              - '**/*.md'
            # "other" = anything not matching the above buckets
            other:
              - '**'
              - '!**/win32/**'
              - '!**/gtk/**'
              - '!**/cocoa/**'
              - '!**/*.md'

  build-linux:
    name: Build (Linux)
    needs: changes
    # push => always; PR => run if gtk changed OR "other" changed (run-everything case)
    if: ${{ github.event_name != 'pull_request' || needs.changes.outputs.gtk == 'true' || needs.changes.outputs.other == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        java: ['21']
        gtk: [gtk3, gtk4]
        compositor: [x11, xwayland, wayland]
    steps:
      - name: Common SWT Build
        uses: ./.github/actions/swt-build
        with:
          java: ${{ matrix.java }}
          native: gtk.linux.x86_64
          gtk: ${{ matrix.gtk }}
          compositor: ${{ matrix.compositor }}
